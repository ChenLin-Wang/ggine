<!DOCTYPE html><html><head><title>Noble City</title><style>html,body{background-color:#111;width:100%;height:100%;margin:0;padding:0;overflow:hidden;display:flex;justify-content:center;align-items:center;}canvas{display:block;image-rendering:pixelated;object-fit:contain;box-shadow:0 0 30px #000}</style></head><body><canvas id="game"></canvas><script>(()=>{var M=class{x=0;y=0;get w(){return this.dom.width}set w(t){this.dom.width=t}get h(){return this.dom.height}set h(t){this.dom.height=t}set s(t){this.sx=t,this.sy=t}sx=1;sy=1;def={bz:1};cursor="default";tolisten=[];render(t={},...i){let n=this._eng;i.length||(i=[t],t={});for(let r of i){this._ctx.save();let e={};if(Object.assign(e,this.def,t,r),(e.click||e.hover||e.press)&&e.p!=null&&this.tolisten.push(e),e.f&&e.f in n.audios){n.audios[e.f].active=!0,n.audios[e.f].volume=e.a??1;continue}let h=e.f!=null&&!(e.f in n.imgs),o=e.b!=null&&!(e.b in n.imgs),s=e.crop!=null&&e.crop.length==4,l=e.crop!=null&&e.crop.length==8;h&&(this._ctx.fillStyle=e.f),o&&(this._ctx.strokeStyle=e.b),this._ctx.lineCap=e.be=="arc"?"round":e.be=="sqr"?"square":"butt",this._ctx.lineJoin=e.bj=="arc"?"round":e.bj=="sqr"?"bevel":"miter",this._ctx.lineWidth=e.bz??1,this._ctx.globalAlpha=e.a??1,this._ctx.save(),e.c=e.c??1;let[a,u]=[Math.pow(this.sx,e.c),Math.pow(this.sy,e.c)];e.sx=(e.sx??e.s??1)*a,e.sy=(e.sy??e.s??1)*u;let[p,g]=e.r?[Math.sin(e.r),Math.cos(e.r)]:[0,1],[x,k]=[this.w/2*e.c*Math.pow(this.sx,e.c-1)+this.x*(1-e.c-a)+(e.x??0)*a,this.h/2*e.c*Math.pow(this.sy,e.c-1)+this.y*(1-e.c-u)+(e.y??0)*u],H=this.rect(e);if(this._ctx.transform(e.sx*g,e.sx*p,-e.sy*p,e.sy*g,x,k),e.m&&e.m.length==6?this._ctx.transform.apply(this._ctx,e.m):e.m&&n.error_add(new Error(`Invalid transform [${e.m.toString()}]`)),this._ctx.translate(H[0][0]/e.sx,H[0][1]/e.sy),e.f!=null&&e.f in n.imgs){if(e.crop&&s)this._ctx.drawImage(n.imgs[e.f],e.crop[0],e.crop[1],e.crop[2],e.crop[3],0,0,e.crop[2],e.crop[3]);else if(e.crop&&l)for(let m=0;m<=e.crop[6];m++)for(let b=0;b<=e.crop[7];b++)this._ctx.drawImage(n.imgs[e.f],e.crop[0]*(m==0?0:m==e.crop[6]?1:.5),e.crop[1]*(b==0?0:b==e.crop[7]?1:.5),e.crop[2],e.crop[3],e.crop[4]*m,e.crop[5]*b,e.crop[2],e.crop[3]);else this._ctx.drawImage(n.imgs[e.f],0,0);e.p=e.p??H}if(this._ctx.restore(),this._ctx.transform(a*g,a*p,-u*p,u*g,x,k),e.p){let m=0,b=0;this._ctx.beginPath();for(let c of e.p)c.length==2&&!m?this._ctx.moveTo(c[0],c[1]):c.length==2&&b==1?(this._ctx.lineTo(e.p[m-2][0]+c[0],e.p[m-2][1]),this._ctx.lineTo(e.p[m-2][0]+c[0],e.p[m-2][1]+c[1]),this._ctx.lineTo(e.p[m-2][0],e.p[m-2][1]+c[1])):c.length==2?this._ctx.lineTo(c[0],c[1]):c.length==0&&m>0&&e.p[m-1].length==2&&m+1!=e.p.length&&e.p[m+1].length==2?b=1:c.length==0&&m+1==e.p.length&&this._ctx.closePath(),m++;o&&this._ctx.stroke(),h&&this._ctx.fill()}if(e.t){let m=e.tz??20,[b,c]=[0,0],[O,A]=[!1,!1];this._ctx.font=`${m}px ${e.tf&&e.tf in n.fonts?n.fonts[e.tf]:e.tf??"Arial"}`,(O=[0,.5,1].includes(e.ox))&&(this._ctx.textAlign=e.ox==0?"start":e.ox==1?"end":"center"),(A=[0,.5,1].includes(e.oy))&&(this._ctx.textBaseline=e.oy==0?"top":e.oy==1?"bottom":"middle"),O||(b=-this._ctx.measureText(e.t).width*e.ox),A||(c=-m*e.oy),o&&this._ctx.strokeText(e.t,b,c),h||(this._ctx.fillStyle="#000"),(!h&&!o||h)&&this._ctx.fillText(e.t,b,c)}this._ctx.restore()}}play(t,i=1){if(t in this._eng.audios){let n=new Audio;return n.src=this._eng.base+t,n.volume=i,n.addEventListener("ended",()=>n=null),n.play(),!0}return!1}clear(){this._ctx.clearRect(0,0,this.w,this.h)}fit=!1;fitfull(){let{width:t,height:i}=(this.dom.parentElement||this.dom).getBoundingClientRect(),n=this.w/this.h;t/i>n?(this.dom.style.width="auto",this.dom.style.height="100%"):(this.dom.style.width="100%",this.dom.style.height="auto")}tile(t){let i=t.sx!=null?t.sx:t.s!=null?t.s:this.def.sx!=null?this.def.sx:this.def.s!=null?this.def.s:1,n=t.sy!=null?t.sy:t.s!=null?t.s:this.def.sy!=null?this.def.sy:this.def.s!=null?this.def.s:1,r=this.dom.getBoundingClientRect(),e=r.width/this.w,h=r.height/this.h;!t.f||!(t.f in this._eng.imgs)?t.f!=null&&(this.dom.style.background=t.f):(this.dom.style.backgroundImage=`url(${this._eng.base}${t.f})`,this.dom.style.backgroundPosition=`calc(50% + ${((t.x||0)-this.x)*this.sx*e}px) calc(50% + ${((t.y||0)-this.y)*this.sy*h}px)`,this.dom.style.backgroundSize=`${this._eng.imgs[t.f].width*this.sx*i}px ${this._eng.imgs[t.f].height*this.sy*n}px`)}merge(...t){let[i,...n]=t,r=[];for(let e of n)r.push({...i,...e});return r}rect(t){let i=t.f!=null&&!(t.f in this._eng.imgs),n=t.crop!=null&&t.crop.length==4,r=t.crop!=null&&t.crop.length==8;t.ox=t.ox??(!t.o||!t.o.includes("w")&&!t.o.includes("e")?.5:t.o&&t.o.includes("e")?1:0),t.oy=t.oy??(!t.o||!t.o.includes("n")&&!t.o.includes("s")?.5:t.o&&t.o.includes("s")?1:0);let e=t.crop&&n?[t.crop[2],t.crop[3]]:t.crop&&r?[t.crop[4]*(t.crop[6]+1),t.crop[5]*(t.crop[7]+1)]:t.f&&!i?[this._eng.imgs[t.f].width,this._eng.imgs[t.f].height]:[0,0];return[[e[0]*-(t.ox??.5)*(t.sx??t.s??1),e[1]*-(t.oy??.5)*(t.sy??t.s??1)],[],[e[0]*(t.sx??t.s??1),e[1]*(t.sy??t.s??1)],[]]}dom;scene=null;_ctx;_eng;constructor(t="",i,n=640,r=360){this.dom=typeof t!="string"?t:t.length&&document.querySelector(t)?document.querySelector(t):document.createElement("canvas"),this.dom.style.aspectRatio=`${n} / ${r}`,this.w=n,this.h=r,this._ctx=this.dom.getContext("2d"),this._ctx.imageSmoothingEnabled=!1,this._eng=i,i.cameras.push(this),i.inp.bind(this)}},q=class{x=0;_x=0;_gx=0;get dx(){return this.x-this._x}set dx(t){this._x=this.x-t}y=0;_y=0;_gy=0;get dy(){return this.y-this._y}set dy(t){this._y=this.y-t}rx=0;_rx=0;_grx=0;get drx(){return this.rx-this._rx}set drx(t){this._rx=this.rx-t}ry=0;_ry=0;_gry=0;get dry(){return this.ry-this._ry}set dry(t){this._ry=this.ry-t}b=0;_b=0;get db(){return this.b^this._b}set db(t){this._b=this.b^t}cb(t,i=null){return(this.db&t)!=0&&(i==null?(this.b&t)!=0:(this.b&t)==i)}sx=0;_sx=0;get dsx(){return this.sx-this._sx}set dsx(t){this._sx=this.sx-t}sy=0;_sy=0;get dsy(){return this.sy-this._sy}set dsy(t){this._sy=this.sy-t}get gx(){return this.x-this._gx}get gy(){return this.y-this._gy}get grx(){return this.rx-this._grx}get gry(){return this.ry-this._gry}get g(){return Math.hypot(this.gx,this.gy)}get gr(){return Math.hypot(this.grx,this.gry)}click(t=1){return this.g<t&&this.cb(1,0)}over(t,i=[0,0],n){let r=n??(this._cam.def.c!=null?this._cam.def.c:1),e=(this.x-this._cam.w/2*r+this._cam.x*r*this._cam.sx)*Math.pow(this._cam.sx,-r)-i[0],h=(this.y-this._cam.h/2*r+this._cam.y*r*this._cam.sy)*Math.pow(this._cam.sy,-r)-i[1],o=!1;for(let s=0,l=t.length-1;s<t.length;l=s++){let a=t[s].length==2&&t[l].length==2;if(s==0&&t[l].length==0&&l--,s!=0&&s+1<t.length&&t[s].length==0&&t[s-1].length==2&&t[s+1].length==2){let u=t[s-1][0],p=t[s-1][1],g=u+t[s+1][0],x=p+t[s+1][1];p>h!=x>h&&u>e!=g>e&&(o=!o),s++}else if(a){let u=t[s][0],p=t[s][1],g=t[l][0],x=t[l][1];p>h!=x>h&&e<(g-u)*(h-p)/(x-p)+u&&(o=!o)}}return o}in(...t){for(let i of t)if(this.x>i[0]&&this.x<i[0]+i[2]&&this.y>i[1]&&this.y<i[1]+i[3])return!0;return!1}rin(...t){for(let i of t)if(this.rx>i[0]&&this.rx<i[0]+i[2]&&this.ry>i[1]&&this.ry<i[1]+i[3])return!0;return!1}key={};dkey={};handle(t){if(t instanceof WheelEvent)this.sx+=t.deltaX,this.sy+=t.deltaY;else if(t instanceof MouseEvent){let i=this._cam.dom.getBoundingClientRect(),n=this._cam.w/this._cam.h,r=n>i.width/i.height?[i.width,i.width/n]:[i.height*n,i.height];this.x=(t.clientX-i.left-(i.width-r[0])/2)/r[0]*this._cam.w,this.y=(t.clientY-i.top-(i.height-r[1])/2)/r[1]*this._cam.h,this.rx=(this.x-this._cam.w/2+this._cam.x)/this._cam.sx,this.ry=(this.y-this._cam.h/2+this._cam.y)/this._cam.sy,this.b=t.buttons,this.cb(1)&&(this._gx=this.x,this._gy=this.y,this._grx=this.rx,this._gry=this.ry),t.preventDefault()}else t instanceof KeyboardEvent&&(t.type=="keydown"?this.key[t.key.toLowerCase()]=this.dkey[t.key.toLowerCase()]=Number(t.ctrlKey)+(Number(t.shiftKey)<<1)+(Number(t.altKey)<<2):(delete this.key[t.key.toLowerCase()],this.dkey[t.key.toLowerCase()]=-1))}reset(){this.dx=0,this.dy=0,this.db=0,this.dsx=0,this.dsy=0,this.drx=0,this.dry=0,this.dkey={}}constructor(t){this._eng=t}_eng;bind(t){this._cam=t,addEventListener("wheel",i=>this.handle(i)),addEventListener("mousemove",i=>this.handle(i)),addEventListener("mouseover",i=>this.handle(i)),addEventListener("mousedown",i=>this.handle(i)),addEventListener("mouseup",i=>this.handle(i)),addEventListener("mouseenter",i=>this.handle(i)),addEventListener("mouseout",i=>this.handle(i)),addEventListener("keydown",i=>this.handle(i)),addEventListener("keyup",i=>this.handle(i))}_cam},_=class{static res=[];static depend=[];render(t,i,n){return[]}eng=null;scene=null;constructor(...t){}},v=class{entities=[];add(...t){for(let i of t)i.eng=this.eng,this.entities.push(i)}remove(...t){for(let i=0;i<this.entities.length;i++)t.includes(this.entities[i])&&(this.entities.slice(i,1),i--)}show(t){t?t.scene=this:this.eng.cameras.length&&(this.eng.cameras[0].scene=this)}eng;constructor(t,...i){this.eng=t,this.add(...i)}},$=class{imgs={};fonts={};audios={};base="";load(t,...i){let n=[];for(let r of i)n.push(...r.res),r.depend.length&&n.push(...this.load(null,...r.depend));return t!=null&&this.load_res(t,...n),n}load_res(t,...i){let n=[],r=!1,e=(o,s)=>{o==-1&&(this.load_err.push(this.base+i[s]),r=!0),n[s][0]=o,t(r?-1:n.map(l=>l[0]/l[1]).reduce((l,a)=>l+a)/n.length)},h=0;for(let o of i){if(o in this.imgs||o in this.fonts||o in this.audios){n.push([0,1]),e(1,h),h++;continue}let s=o.split(".").reverse()[0].toLowerCase();if(["png","jpg","jpeg"].includes(s)){n.push([0,1]);let l=new Image,a=h;l.onload=()=>e(1,a),l.onerror=()=>e(-1,a),l.src=this.base+o,this.imgs[o]=l}else if(["mp3","wav"].includes(s)){n.push([0,1]),this.audios[o]=new Audio;let l=h,a=this.audios[o];a.active=!1,a.oncanplaythrough=()=>e(1,l),a.onerror=()=>e(-1,l),a.src=this.base+o,a.volume=0,a.addEventListener("ended",()=>{a.currentTime=0,a.play()}),a.load()}else if(["ttf","mp3","wav"].includes(s)){n.push([0,5]);let l=h,a=new XMLHttpRequest;a.open("GET",this.base+o),a.responseType="blob",a.onreadystatechange=()=>{if(e(a.readyState,l),a.readyState==4&&a.status!=200)return e(-1,l);if(!(a.readyState!=4||a.status!=200)){if(s=="ttf"){let u=this.fonts[o]=`font_${Object.keys(this.fonts).length}`,p=document.createElement("h1");p.style.font=`20px ${u}`,p.innerHTML=u,p.style.position="fixed",p.style.left="0",p.style.top="100%";let g=document.createElement("style");g.innerHTML+=`@font-face {font-family:"${u}";src:url("${URL.createObjectURL(a.response)}") format("truetype");}`,document.head.appendChild(g),document.body.appendChild(p);let x=k=>{document.fonts.check(`20px ${u}`)?e(5,l):k>1e3?e(-1,l):setTimeout(x,10,k+1)};x(0)}if(["mp3","wav"].includes(s)){this.audios[o]=new Audio;let u=this.audios[o];u.active=!1,u.src=URL.createObjectURL(a.response),u.volume=0,u.addEventListener("ended",()=>{u.currentTime=0,u.play()}),e(5,l)}else e(5,l)}},a.send()}else n.push([0,1]),this.error_add(new Error(`Unknown file type "${s}"`)),e(-1,h);h++}r||t(0)}errors=[];load_err=[];error_add(t){for(let i of this.errors)if(i.message==t.message)return;this.errors.push(t),console.log(t)}cameras=[];inp;debug={m:[1,0,0,1,0,0],_m:[1,0,0,1,0,0],mp:t=>{if(this.inp.key.a!=null&&(this.debug.m[0]-=t*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.m[0]+=t*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),this.inp.key.q!=null&&(this.debug.m[1]-=t*(this.inp.key.q==0?1:this.inp.key.q&2?.25:0)),this.inp.key.e!=null&&(this.debug.m[1]+=t*(this.inp.key.e==0?1:this.inp.key.e&2?.25:0)),this.inp.key.x!=null&&(this.debug.m[2]-=t*(this.inp.key.x==0?1:this.inp.key.x&2?.25:0)),this.inp.key.z!=null&&(this.debug.m[2]+=t*(this.inp.key.z==0?1:this.inp.key.z&2?.25:0)),this.inp.key.s!=null&&(this.debug.m[3]-=t*(this.inp.key.s==0?1:this.inp.key.s&2?.25:0)),this.inp.key.w!=null&&(this.debug.m[3]+=t*(this.inp.key.w==0?1:this.inp.key.w&2?.25:0)),this.inp.key.c!=null&&(this.debug.m[4]-=t*(this.inp.key.c==0?4:this.inp.key.c&2?.25:0)),this.inp.key.v!=null&&(this.debug.m[4]+=t*(this.inp.key.v==0?4:this.inp.key.v&2?.25:0)),this.inp.key.r!=null&&(this.debug.m[5]-=t*(this.inp.key.r==0?4:this.inp.key.r&2?.25:0)),this.inp.key.f!=null&&(this.debug.m[5]+=t*(this.inp.key.f==0?4:this.inp.key.f&2?.25:0)),this.inp.key[1]!=null||this.inp.key[2]!=null){let i=Math.PI/16*t*(this.inp.key[1]!=null?1:-1),n=Math.cos(i),r=Math.sin(i),e=[...this.debug.m];this.debug.m=[e[0]*n+e[2]*r,e[1]*n+e[3]*r,e[2]*n-e[0]*r,e[3]*n-e[1]*r,e[4],e[5]]}if(!Object.keys(this.inp.key).length){for(let i=0;i<6;i++)if(this.debug.m[i]!=this.debug._m[i]){console.log("DEBUG MATRIX:",this.debug.m.toString()),this.debug._m=[...this.debug.m];break}}},v:1,vp:t=>{this.inp.key.a!=null&&(this.debug.v-=t*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.v+=t*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),console.log(this.debug.v)}};_wait=0;_times=[];_start;get fps(){return this._times.length}set fps(t){this._wait=t?2e3/t:0}scene=null;start_loop(t=!0){let i=performance.now(),n=this._times.length?i-this._times[this._times.length-1]:0;this._times=this._times.filter(e=>i-e<=1e3),this._times.push(i),t&&(this._start=i);for(let e in this.audios)this.audios[e].active=!1;let r=0;for(let e of this.cameras){e.cursor="default",e.clear(),e.fit&&e.fitfull(),e.tolisten=[];let h=[];if(e.scene!=null)for(let l of e.scene.entities){let a=e.merge(...l.render(n/1e3,i-this._start,e));for(let u of a)h.push(u)}let o=0,s=0;for(let l=h.length-1;l>=0;l--){let a=h[l];!a.hover&&!a.press&&!a.click||(a.p==null&&(a.p=e.rect(a)),this.inp.over(a.p,[a.x??0,a.y??0],a.c??1)&&(s==0&&a.hover&&a.hover(a),o==0&&a.click&&this.inp.click()&&(a.click(a),o++),a.press&&this.inp.b&1&&this.inp.g<1&&a.press(a)))}e.render({},...h),e.dom.style.cursor=e.cursor,this.loop(n/1e3,i-this._start,e),r++}for(let e in this.audios){let h=this.audios[e];h.active&&h.paused?h.play():!h.active&&!h.paused&&(h.currentTime=0,h.pause())}this.inp.reset(),setTimeout(()=>this.start_loop(!1),this._wait-n>0?this._wait-n:0)}tile(t,i,n=0,r=0,e=1,h=1){let o=(s,l,a)=>{let u=`${n+l}_${r+a}`,p=0;i[u]&&i[u].data&&i[u].data.p&&(p=i[u].data.p);let g=structuredClone(t[p|s]);g.f||(g.f="tile/test.png"),g.data={...i[u]?.data||{},...t[p|s]?.data||{},p:p|s},i[u]=g};for(let s=0;s<e;s++)for(let l=0;l<h;l++)o(15,s,l);for(let s=0;s<e;s++)o(3,s,-1);for(let s=0;s<e;s++)o(12,s,h);for(let s=0;s<h;s++)o(5,-1,s);for(let s=0;s<h;s++)o(10,e,s);o(1,-1,-1),o(2,e,-1),o(4,-1,h),o(8,e,h)}loop=()=>{};act=()=>{};constructor(){this.inp=new q(this),this.start_loop()}};var L=class extends _{per=0;render(t,i,n){return this.eng==null?[]:(console.log(this.per),[{c:0},{p:[[-100,-10],[],[200,20],[]],b:this.per<0?"red":"white",bz:2,x:n.w/2,y:n.h/2},{a:this.per<0?0:1,p:[[-96,-6],[],[192*this.per,12],[]],f:"white",x:n.w/2,y:n.h/2},{t:this.per<0?"Error loading assets":"Loading...",f:this.per<0?"red":"white",x:n.w/2,y:n.h/2-30},{a:this.per<0?.75:0,t:`failed: ${this.eng.load_err[this.eng.load_err.length-1]}`,tz:15,f:"red",x:n.w/2,y:n.h/2+30}])}};var E=class d extends _{static res=["coins.png","ui/title.png","ui/resume.png","ui/options.png","ui/exit.png","ui/close.png","ui/menu.png","ui/bag.png","font/emulogic.ttf","music/bgm1_prototype.wav","sfx/button.mp3","sfx/whoosh.mp3","ui/button_up.png","ui/button_down.png"];box(t,i,n=1,r=1,e=!1){let h=[];"t"in t&&(h.push({t:t.t,tz:20,tf:"font/emulogic.ttf",b:"black",bz:4,x:t.x??0,y:(t.y??0)+3,f:t.f??"white"}),delete t.t,delete t.f),"f"in t&&(h.push({f:t.f,x:(t.x??0)+(t.data?.x??0),y:(t.y??0)+(t.data?.y??0),s:.25,o:t.o??""}),delete t.f);let o=t.click;return"click"in t&&delete t.click,t.click=s=>{s.data&&s.data?.button&&i.play("sfx/button.mp3",.25),o&&o(s)},[{f:"ui/button_up.png",s:.25,crop:[60,59,60,59,57,56,n,r],press:s=>{s.data&&s.data.button&&(s.f="ui/button_down.png")},...t,data:{...t.data??{},button:!e}},...h]}money=1e3;menu=0;m=0;focus=null;title="Inventory";render(t,i,n){if(this.eng==null)return[];this.m+=(this.menu-this.m)*t*10;let r=(...o)=>o.map(s=>Math.max(0,1-Math.abs(this.m-s))).reduce((s,l)=>s+l,0),e=Math.floor(i/200)%4,h=(o,s=1,l=1,a=!1)=>this.box(o,n,s,l,a);return this.eng?.debug.mp(t),this.menu!=2&&this.focus!=null&&Math.abs(this.m-2)>.9&&(this.focus=null),[{c:0,hover:o=>{o.click&&(o.cur="pointer")}},{f:"music/bgm1_prototype.wav"},{f:"black",p:[[0,0],[],[n.w,n.h]],a:.5*r(0,2)},...this.focus==null?[]:n.merge(...this.focus.render(t,i,n)),{x:n.w*.5,y:n.h*.25*(2*r(0)-1),f:d.res[1],s:.35},{f:"coins.png",x:(n.w*.72+25)*r(0)-50*r(0)+25,y:(n.h*.2+25)*r(0)-50*r(0)+25,crop:[Math.abs(2-e)*22,0,22,23],sx:e==1?-1.5:1.5,sy:1.5},{t:String(this.money),tz:20,tf:"font/emulogic.ttf",x:44,y:28-38*r(0),o:"w",f:"gold",b:"black",bz:4},{t:String(this.eng.fps),o:"nw",tz:8},...h({x:n.w/2,y:n.h-200*r(0)+50,t:"resume",f:"#4CAF50",click:o=>this.menu=1},10,2),...h({x:n.w/2,y:n.h-200*r(0)+105,t:"options",f:"#2196F3"},10,2),...h({x:n.w/2,y:n.h-200*r(0)+160,t:"exit",f:"#F44336"},10,2),...h({x:n.w+30-40*r(1),y:10,o:"ne",f:"ui/menu.png",click:o=>this.menu=0,data:{x:-3,y:9}}),...h({x:n.w+30-80*r(1),y:10,o:"ne",f:"ui/bag.png",click:o=>{this.title="Inventory",this.menu=2},data:{x:-7,y:7}}),...h({x:n.w+70-80*r(2),y:10,o:"ne",f:"ui/close.png",click:o=>{this.eng?.act("building_off"),this.menu=1},data:{x:-4,y:6}}),...this.focus==null?[...h({x:n.w/2,y:n.h+150-(n.h/2+135)*r(2)},40,19,!0)]:[...h({x:n.w+150-(n.w/2+5)*r(2),y:n.h/2+15},20,19,!0),...h({x:n.w/8,y:7*n.h/8},5,2)],{t:this.title,tz:20,tf:"font/emulogic.ttf",b:"black",bz:4,x:n.w/2,y:28*r(2)-10*(1-r(2)),f:"skyblue"}]}};var f=class extends _{static key="";focused=!1;own=1;popup=[];x;y;name="Building";base(t,i,n,r=1){this._c+=((this.focused?0:1)-this._c)*t*10;let e=this._c;return{c:e,x:this.x*e+.25*n.w*(1-e),y:this.y*e+.75*n.h*(1-e),s:r*e+1*(1-e),click:h=>this.eng?.act("building",this)}}_c=1;render_pin(t,i,n,r=1){return this.popup.length==0?[]:[{x:this.x,y:this.y-100},{f:"ui/pin.png",s:.25,oy:.4,click:e=>this.eng?.act("building",this)},...this.popup]}constructor(t,i,n,r){super(),this.eng=t.eng,this.x=i*72+n*64,this.y=n*36-i*19}};var T=class extends f{static res=["building/bank.png"];static key="bank";name="DBO Bank";render(t,i,n){return[this.base(t,i,n),{f:"building/bank.png",p:[[-62,-100],[],[133,130],[]],m:[1,0,0,1,4,-32]}]}};var j=class extends f{static res=["building/blank_mask.png"];static key="blank";name="Private building";color=["white","white","white"];render(t,i,n){let r=this.base(t,i,n);return[{x:r.x??0,y:r.y??0,c:r.c??1},{p:[[-45,-33],[0,-7],[50,-20],[50,11],[0,24],[-38,2],[-45,0],[]],f:this.color[0]},{p:[[-45,-65],[0,-39],[50,-52],[50,-20],[0,-7],[-45,-33],[]],f:this.color[1]},{p:[[-49,-69.5],[8,-85],[54,-58],[54,-54],[53,-53],[53,-50],[0,-36],[-47,-64],[-47,-65],[-49,-67],[]],f:this.color[2]},{f:"building/blank_mask.png",p:[[-48,-85],[],[102,110],[]],m:[1,0,0,1,0,-30],...r}]}constructor(t,i,n,r){super(t,i,n,r),r.color?.length==3&&(this.color=r.color)}};var z=class extends f{static res=["building/callereal.png"];static key="callereal";name="Calle Real Market";render(t,i,n){return[this.base(t,i,n),{f:"building/callereal.png",p:[[-85,-140],[],[185,160],[]],m:[1,0,0,1,0,-60]}]}};var S=class extends f{static res=["building/factory.png"];static key="factory";name="Factory";render(t,i,n){return[this.base(t,i,n),{f:"building/factory.png",p:[[-75,-125],[],[165,145],[]],m:[1,0,0,1,0,-50]}]}};var B=class extends f{static res=["building/farm.png"];static key="farm";name="Farm";render(t,i,n){return[this.base(t,i,n),{f:"building/farm.png",p:[[-64,-49],[],[120,97],[]]}]}};var R=class extends f{static res=["building/fishing.png"];static key="fishing";name="Fishing Market";render(t,i,n){return[this.base(t,i,n,.75),{f:"building/fishing.png",m:[1,0,0,1,5,-35],p:[[-70,-80],[],[145,110],[]]}]}};var C=class d extends _{static res=["tile/grass_0.png","tile/sand_0.png","tile/sand1.png","tile/water_0.png","tile/water_1.png","tile/ws_x_0.png","tile/ws_y_0.png","tile/ws_xy_0.png","tile/ws__0.png","tile/ws_x_1.png","tile/ws_y_1.png","tile/ws_xy_1.png","tile/ws__1.png","tile/test.png","road/dirt.png","road/dirt_empty.png","road/cement.png","road/cement_empty.png","prop/tree.png","tile/water_bg_0.png","tile/water_bg_1.png","ui/pin.png"];static depend=[S,R,z,T,B,j];ly=[{},{}];bd={};tile(t,i){return{x:t*72+i*64,y:i*36-t*19}}generate(t=[]){this.ly=[{},{}],this.bd={};let[i,n]=this.ly,r=this.bd;for(let e of t){let h=!0;if(e.w==null&&(e.w=1),e.h==null&&(e.h=1),e.type=="sand")this.eng?.tile([{},{data:{pre:"ws_xy"},m:[.312,.463,-2.45,-.23,-1,1]},{data:{pre:"ws_xy"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_y"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_xy"}},{data:{pre:"ws_x"}},{},{data:{pre:"ws_"},m:[-.2404,-.45704,2.5288,.2536,0,0]},{data:{pre:"ws_xy"},m:[-.355,.37,2.31,.38,-1,1]},{},{data:{pre:"ws_x"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_"},m:[1,0,0,1,-2,0]},{data:{pre:"ws_y"}},{data:{pre:"ws_"},m:[.95175,.235,.275,-.951,0,.6285]},{data:{pre:"ws_"},m:[.26139,.4746,-2.4687,-.27096,4.952,2.076]},{data:{pre:"sand"}}],i,e.x,e.y,e.w,e.h);else if(e.type=="grass"){let o="";for(let s=0;s<e.w;s++)for(let l=0;l<e.h;l++)i[o=`${s+e.x}_${l+e.y}`]&&i[o].data?.pre=="sand"&&(i[o].data={...i[o].data||{},top:"grass"})}else if(e.type=="dirt")for(let o=0;o<e.w;o++){let s=`${e.v?e.x:e.x+o}_${e.v?e.y+o:e.y}`;s in n?n[s]={f:"road/dirt_empty.png",m:[1.33725,-.071745,-.24675,1.2205,0,0]}:s in i&&(n[s]={f:"road/dirt.png",m:e.v?[1.33725,-.071745,-.24675,1.2205,0,0]:[-1.27025,-.39275,0,1.2135,0,0]})}else if(e.type=="cement")for(let o=0;o<e.w;o++){let s=`${e.v?e.x:e.x+o}_${e.v?e.y+o:e.y}`;s in n?n[s]={f:"road/cement_empty.png",m:[1.33725,-.071745,-.24675,1.2205,0,0]}:s in i&&(n[s]={f:"road/cement.png",m:e.v?[1.33725,-.071745,-.24675,1.2205,0,0]:[-1.27025,-.39275,0,1.2135,0,0]})}else e.type=="tree"?n[`${e.x}_${e.y}`]={f:"prop/tree.png",p:[[-62,-100],[],[133,130],[]],s:.08}:h=!1;if(!h)for(let o of d.depend)e.type==o.key&&(console.log("ADDED",e.type),n[`${e.x}_${e.y}`]={data:{build:new o(this,e.x,e.y,e)}},h=!0);h||this.eng?.error_add(new Error(`Unknown type "${e.type}`))}for(let e in this.ly)for(let h in this.ly[e]){let o=h.split("_").map(l=>Number(l)),s=this.ly[e][h];Object.assign(s,{x:o[0]*72+o[1]*64,y:o[1]*36-o[0]*19}),e=="0"&&s.data?.pre&&(s.f=`tile/${s.data.top||s.data.pre}_0.png`)}}init=!0;render(t,i,n){n.tile({f:`tile/water_bg_${Math.floor(i/800)%2}.png`,s:1.5});for(let e in this.ly[0]){let h=this.ly[0][e];h.data&&h.data.pre&&h.data.pre[0]=="w"&&!h.data.top&&(h.f=`tile/${h.data.pre}_${Math.floor(i/800)%2}.png`)}return[{hover:e=>{e.click&&(e.cur="pointer")}},...Object.values(this.ly[0]),...Object.values(this.ly[1]).map(e=>e.data?.build?[...n.merge(...e.data.build.render(t,i,n)),...n.merge(...e.data.build.render_pin(t,i,n))]:[e]).reduce((e,h)=>[...e,...h],[])]}};var w=new $;w.base="/assets/";var I=new M("#game",w);I.fit=!0;var D=[{type:"sand",x:-10,y:-10,w:20,h:20},{type:"grass",x:-9,y:-9,w:18,h:18},{type:"fishing",x:7,y:9},{type:"dirt",x:3,y:-8,w:16,v:!0},{type:"cement",x:-8,y:1,w:16},{type:"bank",x:2,y:0},{type:"tree",x:1.6,y:0},{type:"callereal",x:0,y:0},{type:"farm",x:-1,y:0},{type:"factory",x:-3,y:0},{type:"blank",x:5,y:0,color:["blue","brown","violet"]},{type:"blank",x:4,y:0,color:["red","yellow","green"]}];for(let d=0;d<10;d++)for(let t=0;t<10;t++)D.push({type:"tree",x:-8+t*.5+(Math.random()-.5),y:-8+d*.5+(Math.random()-.5)});var U=new L,F=new v(w,U);F.show(I);var X=new C(w),y=new E,P=new v(w,X,y);X.generate(D);w.act=(d,...t)=>{if(d=="building")y.menu==1&&setTimeout(()=>{if(y.menu!=1||!t.length||!(t[0]instanceof f))return;I.play("sfx/whoosh.mp3");let i=t[0];i.focused=!0,y.title=i.name,y.menu=2,y.focus=i},0);else if(d=="building_off")y.focus instanceof f&&(y.focus.focused=!1);else if(d=="onmap?")return y.menu==1};w.load(d=>{U.per=d,d==1&&P.show()},E,C);w.loop=(d,t,i)=>{if(y.menu==0)return;let n=w.inp;if(y.menu==1){if(n.dsy){let r=Math.max(.25,Math.min(8,i.sx*Math.pow(2,-n.dsy/100)));i.s=r}if(n.cb(1)&&n.dx&&n.dy,n.b&1){i.x-=n.dx/i.sx,i.y-=n.dy/i.sy;let r=1300*Math.min(1,i.sx),e=600*Math.min(1,i.sy);i.x=Math.min(r,Math.max(-r,i.x)),i.y=Math.min(e,Math.max(-e,i.y))}}};})();</script></body></html>