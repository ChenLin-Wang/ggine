<!DOCTYPE html><html><head><title>Noble City</title><style>html,body{background-color:#111;width:100%;height:100%;margin:0;padding:0;overflow:hidden;display:flex;justify-content:center;align-items:center;}canvas{display:block;image-rendering:pixelated;object-fit:contain;box-shadow:0 0 30px #000}</style></head><body><canvas id="game"></canvas><script>(()=>{var M=class{x=0;y=0;sm=1;get w(){return Math.floor(this.dom.width/this.sm)}set w(e){this.dom.width=e}get h(){return Math.floor(this.dom.height/this.sm)}set h(e){this.dom.height=e}set s(e){this.sx=e,this.sy=e}sx=1;sy=1;scale(e){this.dom.width*=e,this.dom.height*=e,this._ctx=this.dom.getContext("2d"),this._ctx.imageSmoothingEnabled=!1,this._ctx.scale(e,e),this.sm*=e}def={bz:1};cursor="default";tolisten=[];render(e={},...i){let s=this._eng;i.length||(i=[e],e={});for(let n of i){this._ctx.save();let t={};if(Object.assign(t,this.def,e,n),(t.click||t.hover||t.press)&&t.p!=null&&this.tolisten.push(t),t.f&&t.f in s.audios){s.audios[t.f].active=!0,s.audios[t.f].volume=t.a??1;continue}let r=t.f!=null&&!(t.f in s.imgs),o=t.b!=null&&!(t.b in s.imgs),h=t.crop!=null&&t.crop.length==4,l=t.crop!=null&&t.crop.length==8;r&&(this._ctx.fillStyle=t.f),o&&(this._ctx.strokeStyle=t.b),this._ctx.lineCap=t.be=="arc"?"round":t.be=="sqr"?"square":"butt",this._ctx.lineJoin=t.bj=="arc"?"round":t.bj=="sqr"?"bevel":"miter",this._ctx.lineWidth=t.bz??1,this._ctx.globalAlpha=t.a??1,this._ctx.save(),t.c=t.c??1;let[a,p]=[Math.pow(this.sx,t.c),Math.pow(this.sy,t.c)];t.sx=(t.sx??t.s??1)*a,t.sy=(t.sy??t.s??1)*p;let[d,b]=t.r?[Math.sin(t.r),Math.cos(t.r)]:[0,1],[w,v]=[this.w/2*t.c*Math.pow(this.sx,t.c-1)+this.x*(1-t.c-a)+(t.x??0)*a,this.h/2*t.c*Math.pow(this.sy,t.c-1)+this.y*(1-t.c-p)+(t.y??0)*p],H=this.rect(t);if(this._ctx.transform(t.sx*b,t.sx*d,-t.sy*d,t.sy*b,w,v),t.m&&t.m.length==6?this._ctx.transform.apply(this._ctx,t.m):t.m&&s.error_add(new Error(`Invalid transform [${t.m.toString()}]`)),this._ctx.translate(H[0][0]/t.sx,H[0][1]/t.sy),t.f!=null&&t.f in s.imgs){if(t.crop&&h)this._ctx.drawImage(s.imgs[t.f],t.crop[0],t.crop[1],t.crop[2],t.crop[3],0,0,t.crop[2],t.crop[3]);else if(t.crop&&l)for(let m=0;m<=t.crop[6];m++)for(let _=0;_<=t.crop[7];_++)this._ctx.drawImage(s.imgs[t.f],t.crop[0]*(m==0?0:m==t.crop[6]?1:.5),t.crop[1]*(_==0?0:_==t.crop[7]?1:.5),t.crop[2],t.crop[3],t.crop[4]*m,t.crop[5]*_,t.crop[2],t.crop[3]);else this._ctx.drawImage(s.imgs[t.f],0,0);t.p=t.p??H}if(this._ctx.restore(),this._ctx.transform(a*b,a*d,-p*d,p*b,w,v),t.p){let m=0,_=0;this._ctx.beginPath();for(let g of t.p)g.length==2&&!m?this._ctx.moveTo(g[0],g[1]):g.length==2&&_==1?(this._ctx.lineTo(t.p[m-2][0]+g[0],t.p[m-2][1]),this._ctx.lineTo(t.p[m-2][0]+g[0],t.p[m-2][1]+g[1]),this._ctx.lineTo(t.p[m-2][0],t.p[m-2][1]+g[1])):g.length==2?this._ctx.lineTo(g[0],g[1]):g.length==0&&m>0&&t.p[m-1].length==2&&m+1!=t.p.length&&t.p[m+1].length==2?_=1:g.length==0&&m+1==t.p.length&&this._ctx.closePath(),m++;o&&this._ctx.stroke(),r&&(t.bz??1)&&this._ctx.fill()}if(t.t){let m=t.tz??20,[_,g]=[0,0],[O,U]=[!1,!1];this._ctx.font=`${m}px ${t.tf&&t.tf in s.fonts?s.fonts[t.tf]:t.tf??"Arial"}`,(O=[0,.5,1].includes(t.ox))&&(this._ctx.textAlign=t.ox==0?"start":t.ox==1?"end":"center"),(U=[0,.5,1].includes(t.oy))&&(this._ctx.textBaseline=t.oy==0?"top":t.oy==1?"bottom":"middle"),O||(_=-this._ctx.measureText(t.t).width*t.ox),U||(g=-m*t.oy),o&&(t.bz??1)&&this._ctx.strokeText(t.t,_,g),r||(this._ctx.fillStyle="#000"),(!r&&!o||r)&&this._ctx.fillText(t.t,_,g)}this._ctx.restore()}}play(e,i=1,s=0){if(e in this._eng.audios){let n=new Audio;return n.src=this._eng.base+e,n.volume=i,n.currentTime=s,n.addEventListener("ended",()=>n=null),n.play(),!0}return!1}clear(){this._ctx.clearRect(0,0,this.w,this.h)}fit=!1;fitfull(){let{width:e,height:i}=(this.dom.parentElement||this.dom).getBoundingClientRect(),s=this.w/this.h;e/i>s?(this.dom.style.width="auto",this.dom.style.height="100%"):(this.dom.style.width="100%",this.dom.style.height="auto")}tile(e){let i=e.sx!=null?e.sx:e.s!=null?e.s:this.def.sx!=null?this.def.sx:this.def.s!=null?this.def.s:1,s=e.sy!=null?e.sy:e.s!=null?e.s:this.def.sy!=null?this.def.sy:this.def.s!=null?this.def.s:1,n=this.dom.getBoundingClientRect(),t=n.width/this.w,r=n.height/this.h;!e.f||!(e.f in this._eng.imgs)?e.f!=null&&(this.dom.style.background=e.f):(this.dom.style.backgroundImage=`url(${this._eng.base}${e.f})`,this.dom.style.backgroundPosition=`calc(50% + ${((e.x||0)-this.x)*this.sx*t}px) calc(50% + ${((e.y||0)-this.y)*this.sy*r}px)`,this.dom.style.backgroundSize=`${this._eng.imgs[e.f].width*this.sx*i}px ${this._eng.imgs[e.f].height*this.sy*s}px`)}merge(...e){let[i,...s]=e,n=[];for(let t of s)n.push({...i,...t});return n}rect(e){let i=e.f!=null&&!(e.f in this._eng.imgs),s=e.crop!=null&&e.crop.length==4,n=e.crop!=null&&e.crop.length==8;e.ox=e.ox??(!e.o||!e.o.includes("w")&&!e.o.includes("e")?.5:e.o&&e.o.includes("e")?1:0),e.oy=e.oy??(!e.o||!e.o.includes("n")&&!e.o.includes("s")?.5:e.o&&e.o.includes("s")?1:0);let t=e.crop&&s?[e.crop[2],e.crop[3]]:e.crop&&n?[e.crop[4]*(e.crop[6]+1),e.crop[5]*(e.crop[7]+1)]:e.f&&!i?[this._eng.imgs[e.f].width,this._eng.imgs[e.f].height]:[0,0];return[[t[0]*-(e.ox??.5)*(e.sx??e.s??1),t[1]*-(e.oy??.5)*(e.sy??e.s??1)],[],[t[0]*(e.sx??e.s??1),t[1]*(e.sy??e.s??1)],[]]}dom;scene=null;_ctx;_eng;constructor(e="",i,s=640,n=360){this.dom=typeof e!="string"?e:e.length&&document.querySelector(e)?document.querySelector(e):document.createElement("canvas"),this.dom.style.aspectRatio=`${s} / ${n}`,this.w=s,this.h=n,this._ctx=this.dom.getContext("2d"),this._ctx.imageSmoothingEnabled=!1,this._eng=i,i.cameras.push(this),i.inp.bind(this)}},q=class{x=0;_x=0;_gx=0;get dx(){return this.x-this._x}set dx(e){this._x=this.x-e}y=0;_y=0;_gy=0;get dy(){return this.y-this._y}set dy(e){this._y=this.y-e}rx=0;_rx=0;_grx=0;get drx(){return this.rx-this._rx}set drx(e){this._rx=this.rx-e}ry=0;_ry=0;_gry=0;get dry(){return this.ry-this._ry}set dry(e){this._ry=this.ry-e}b=0;_b=0;get db(){return this.b^this._b}set db(e){this._b=this.b^e}cb(e,i=null){return(this.db&e)!=0&&(i==null?(this.b&e)!=0:(this.b&e)==i)}sx=0;_sx=0;get dsx(){return this.sx-this._sx}set dsx(e){this._sx=this.sx-e}sy=0;_sy=0;get dsy(){return this.sy-this._sy}set dsy(e){this._sy=this.sy-e}get gx(){return this.x-this._gx}get gy(){return this.y-this._gy}get grx(){return this.rx-this._grx}get gry(){return this.ry-this._gry}get g(){return Math.hypot(this.gx,this.gy)}get gr(){return Math.hypot(this.grx,this.gry)}click(e=1){return this.g<e&&this.cb(1,0)}over(e,i=[0,0],s){let n=s??(this._cam.def.c!=null?this._cam.def.c:1),t=(this.x-this._cam.w/2*n+this._cam.x*n*this._cam.sx)*Math.pow(this._cam.sx,-n)-i[0],r=(this.y-this._cam.h/2*n+this._cam.y*n*this._cam.sy)*Math.pow(this._cam.sy,-n)-i[1],o=!1;for(let h=0,l=e.length-1;h<e.length;l=h++){let a=e[h].length==2&&e[l].length==2;if(h==0&&e[l].length==0&&l--,h!=0&&h+1<e.length&&e[h].length==0&&e[h-1].length==2&&e[h+1].length==2){let p=e[h-1][0],d=e[h-1][1],b=p+e[h+1][0],w=d+e[h+1][1];d>r!=w>r&&p>t!=b>t&&(o=!o),h++}else if(a){let p=e[h][0],d=e[h][1],b=e[l][0],w=e[l][1];d>r!=w>r&&t<(b-p)*(r-d)/(w-d)+p&&(o=!o)}}return o}in(...e){for(let i of e)if(this.x>i[0]&&this.x<i[0]+i[2]&&this.y>i[1]&&this.y<i[1]+i[3])return!0;return!1}rin(...e){for(let i of e)if(this.rx>i[0]&&this.rx<i[0]+i[2]&&this.ry>i[1]&&this.ry<i[1]+i[3])return!0;return!1}key={};dkey={};handle(e){if(e instanceof WheelEvent)this.sx+=e.deltaX,this.sy+=e.deltaY;else if(e instanceof MouseEvent){let i=this._cam.dom.getBoundingClientRect(),s=this._cam.w/this._cam.h,n=s>i.width/i.height?[i.width,i.width/s]:[i.height*s,i.height];this.x=(e.clientX-i.left-(i.width-n[0])/2)/n[0]*this._cam.w,this.y=(e.clientY-i.top-(i.height-n[1])/2)/n[1]*this._cam.h,this.rx=(this.x-this._cam.w/2+this._cam.x)/this._cam.sx,this.ry=(this.y-this._cam.h/2+this._cam.y)/this._cam.sy,this.b=e.buttons,this.cb(1)&&(this._gx=this.x,this._gy=this.y,this._grx=this.rx,this._gry=this.ry),e.preventDefault()}else e instanceof KeyboardEvent&&(e.type=="keydown"?this.key[e.key.toLowerCase()]=this.dkey[e.key.toLowerCase()]=Number(e.ctrlKey)+(Number(e.shiftKey)<<1)+(Number(e.altKey)<<2):(delete this.key[e.key.toLowerCase()],this.dkey[e.key.toLowerCase()]=-1))}reset(){this.dx=0,this.dy=0,this.db=0,this.dsx=0,this.dsy=0,this.drx=0,this.dry=0,this.dkey={}}constructor(e){this._eng=e}_eng;bind(e){this._cam=e,addEventListener("wheel",i=>this.handle(i)),addEventListener("mousemove",i=>this.handle(i)),addEventListener("mouseover",i=>this.handle(i)),addEventListener("mousedown",i=>this.handle(i)),addEventListener("mouseup",i=>this.handle(i)),addEventListener("mouseenter",i=>this.handle(i)),addEventListener("mouseout",i=>this.handle(i)),addEventListener("keydown",i=>this.handle(i)),addEventListener("keyup",i=>this.handle(i))}_cam},k=class{static res=[];static depend=[];render(e,i,s){return[]}eng=null;scene=null;constructor(...e){}},E=class{entities=[];add(...e){for(let i of e)i.eng=this.eng,this.entities.push(i)}remove(...e){for(let i=0;i<this.entities.length;i++)e.includes(this.entities[i])&&(this.entities.slice(i,1),i--)}show(e){e?e.scene=this:this.eng.cameras.length&&(this.eng.cameras[0].scene=this)}eng;constructor(e,...i){this.eng=e,this.add(...i)}},$=class{imgs={};fonts={};audios={};base="";load(e,...i){let s=[];for(let n of i)s.push(...n.res),n.depend.length&&s.push(...this.load(null,...n.depend));return e!=null&&this.load_res(e,...s),s}load_res(e,...i){let s=[],n=!1,t=(o,h)=>{o==-1&&(this.load_err.push(this.base+i[h]),n=!0),s[h][0]=o,e(n?-1:s.map(l=>l[0]/l[1]).reduce((l,a)=>l+a)/s.length)},r=0;for(let o of i){if(o in this.imgs||o in this.fonts||o in this.audios){s.push([0,1]),t(1,r),r++;continue}let h=o.split(".").reverse()[0].toLowerCase();if(["png","jpg","jpeg"].includes(h)){s.push([0,1]);let l=new Image,a=r;l.onload=()=>t(1,a),l.onerror=()=>t(-1,a),l.src=this.base+o,this.imgs[o]=l}else if(["mp3","wav"].includes(h)){s.push([0,1]),this.audios[o]=new Audio;let l=r,a=this.audios[o];a.active=!1,a.oncanplaythrough=()=>t(1,l),a.onerror=()=>t(-1,l),a.src=this.base+o,a.volume=0,a.addEventListener("ended",()=>{a.currentTime=0,a.play()}),a.load()}else if(["ttf","mp3","wav"].includes(h)){s.push([0,5]);let l=r,a=new XMLHttpRequest;a.open("GET",this.base+o),a.responseType="blob",a.onreadystatechange=()=>{if(t(a.readyState,l),a.readyState==4&&a.status!=200)return t(-1,l);if(!(a.readyState!=4||a.status!=200)){if(h=="ttf"){let p=this.fonts[o]=`font_${Object.keys(this.fonts).length}`,d=document.createElement("h1");d.style.font=`20px ${p}`,d.innerHTML=p,d.style.position="fixed",d.style.left="0",d.style.top="100%";let b=document.createElement("style");b.innerHTML+=`@font-face {font-family:"${p}";src:url("${URL.createObjectURL(a.response)}") format("truetype");}`,document.head.appendChild(b),document.body.appendChild(d);let w=v=>{document.fonts.check(`20px ${p}`)?t(5,l):v>1e3?t(-1,l):setTimeout(w,10,v+1)};w(0)}if(["mp3","wav"].includes(h)){this.audios[o]=new Audio;let p=this.audios[o];p.active=!1,p.src=URL.createObjectURL(a.response),p.volume=0,p.addEventListener("ended",()=>{p.currentTime=0,p.play()}),t(5,l)}else t(5,l)}},a.send()}else s.push([0,1]),this.error_add(new Error(`Unknown file type "${h}"`)),t(-1,r);r++}n||e(0)}errors=[];load_err=[];error_add(e){for(let i of this.errors)if(i.message==e.message)return;this.errors.push(e),console.log(e)}cameras=[];inp;debug={m:[1,0,0,1,0,0],_m:[1,0,0,1,0,0],mp:e=>{if(this.inp.key.a!=null&&(this.debug.m[0]-=e*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.m[0]+=e*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),this.inp.key.q!=null&&(this.debug.m[1]-=e*(this.inp.key.q==0?1:this.inp.key.q&2?.25:0)),this.inp.key.e!=null&&(this.debug.m[1]+=e*(this.inp.key.e==0?1:this.inp.key.e&2?.25:0)),this.inp.key.x!=null&&(this.debug.m[2]-=e*(this.inp.key.x==0?1:this.inp.key.x&2?.25:0)),this.inp.key.z!=null&&(this.debug.m[2]+=e*(this.inp.key.z==0?1:this.inp.key.z&2?.25:0)),this.inp.key.s!=null&&(this.debug.m[3]-=e*(this.inp.key.s==0?1:this.inp.key.s&2?.25:0)),this.inp.key.w!=null&&(this.debug.m[3]+=e*(this.inp.key.w==0?1:this.inp.key.w&2?.25:0)),this.inp.key.c!=null&&(this.debug.m[4]-=e*(this.inp.key.c==0?4:this.inp.key.c&2?.25:0)),this.inp.key.v!=null&&(this.debug.m[4]+=e*(this.inp.key.v==0?4:this.inp.key.v&2?.25:0)),this.inp.key.r!=null&&(this.debug.m[5]-=e*(this.inp.key.r==0?4:this.inp.key.r&2?.25:0)),this.inp.key.f!=null&&(this.debug.m[5]+=e*(this.inp.key.f==0?4:this.inp.key.f&2?.25:0)),this.inp.key[1]!=null||this.inp.key[2]!=null){let i=Math.PI/16*e*(this.inp.key[1]!=null?1:-1),s=Math.cos(i),n=Math.sin(i),t=[...this.debug.m];this.debug.m=[t[0]*s+t[2]*n,t[1]*s+t[3]*n,t[2]*s-t[0]*n,t[3]*s-t[1]*n,t[4],t[5]]}if(!Object.keys(this.inp.key).length){for(let i=0;i<6;i++)if(this.debug.m[i]!=this.debug._m[i]){console.log("DEBUG MATRIX:",this.debug.m.toString()),this.debug._m=[...this.debug.m];break}}},v:1,vp:e=>{this.inp.key.a!=null&&(this.debug.v-=e*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.v+=e*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),console.log(this.debug.v)}};_wait=0;_times=[];_start;get fps(){return this._times.length}set fps(e){this._wait=e?2e3/e:0}scene=null;start_loop(e=!0){let i=performance.now(),s=this._times.length?i-this._times[this._times.length-1]:0;this._times=this._times.filter(t=>i-t<=1e3),this._times.push(i),e&&(this._start=i);for(let t in this.audios)this.audios[t].active=!1;let n=0;for(let t of this.cameras){t.cursor="default",t.clear(),t.fit&&t.fitfull(),t.tolisten=[];let r=[];if(t.scene!=null)for(let l of t.scene.entities){let a=t.merge(...l.render(s/1e3,i-this._start,t));for(let p of a)r.push(p)}let o=0,h=0;for(let l=r.length-1;l>=0;l--){let a=r[l];!a.hover&&!a.press&&!a.click||(a.p==null&&(a.p=t.rect(a)),this.inp.over(a.p,[a.x??0,a.y??0],a.c??1)&&(h==0&&a.hover&&a.hover(a),o==0&&a.click&&this.inp.click()&&(a.click(a),o++),a.press&&this.inp.b&1&&this.inp.g<1&&a.press(a)))}t.render({},...r),t.dom.style.cursor=t.cursor,this.loop(s/1e3,i-this._start,t),n++}for(let t in this.audios){let r=this.audios[t];r.active&&r.paused?r.play():!r.active&&!r.paused&&(r.currentTime=0,r.pause())}this.inp.reset(),setTimeout(()=>this.start_loop(!1),this._wait-s>0?this._wait-s:0)}tile(e,i,s=0,n=0,t=1,r=1){let o=(h,l,a)=>{let p=`${s+l}_${n+a}`,d=0;i[p]&&i[p].data&&i[p].data.p&&(d=i[p].data.p);let b=structuredClone(e[d|h]);b.f||(b.f="tile/test.png"),b.data={...i[p]?.data||{},...e[d|h]?.data||{},p:d|h},i[p]=b};for(let h=0;h<t;h++)for(let l=0;l<r;l++)o(15,h,l);for(let h=0;h<t;h++)o(3,h,-1);for(let h=0;h<t;h++)o(12,h,r);for(let h=0;h<r;h++)o(5,-1,h);for(let h=0;h<r;h++)o(10,t,h);o(1,-1,-1),o(2,t,-1),o(4,-1,r),o(8,t,r)}loop=()=>{};act=()=>{};constructor(){this.inp=new q(this),this.start_loop()}};var L=class extends k{per=0;render(e,i,s){return this.eng==null?[]:[{c:0},{p:[[-100,-10],[],[200,20],[]],b:this.per<0?"red":"white",bz:2,x:s.w/2,y:s.h/2},{a:this.per<0?0:1,p:[[-96,-6],[],[192*this.per,12],[]],f:"white",x:s.w/2,y:s.h/2},{t:this.per<0?"Error loading assets":"Loading...",f:this.per<0?"red":"white",x:s.w/2,y:s.h/2-30},{a:this.per<0?.75:0,t:`failed: ${this.eng.load_err[this.eng.load_err.length-1]}`,tz:15,f:"red",x:s.w/2,y:s.h/2+30}]}};var f=class extends k{static key="";focused=!1;own=1;price=0;popup=[];x;y;name="Building";base(e,i,s,n=1){this._c+=((this.focused?0:1)-this._c)*e*10;let t=this._c;return{c:t,x:this.x*t+.25*s.w*(1-t),y:this.y*t+.6*s.h*(1-t),s:n*t+1*(1-t),click:r=>this.eng?.act("building",this)}}_c=1;render_pin(e,i,s,n=1){return this.popup.length==0?[]:[{x:this.x,y:this.y-100},{f:"ui/pin.png",s:.25,oy:.4,click:t=>this.eng?.act("building",this)},...this.popup]}menu(e,i,s,n){return[]}constructor(e,i,s,n){super(),this.eng=e.eng,this.x=i*72+s*64,this.y=s*36-i*19}};var A=class{money=0;own=[];get saving(){return this.savings[this.savings.length-1]}get loan(){return this.loans[this.loans.length-1]}savings=[0];loans=[0];loaned(e){if(e<0&&this.money<-e)return y.act("pop",[{t:"Insufficent funds ",f:"#F44336",tz:15}]);if(this.loan+e>1e5)return y.act("pop",[{t:"Reached max loan",f:"#F44336",tz:15}]);this.money+=e,this.loans.push(this.loan+e)}saved(e){if(e<0&&this.saving<-e)return y.act("pop",[{t:"Insufficent savings ",f:"#F44336",tz:15}]);if(this.money<e)return y.act("pop",[{t:"Insufficent funds",f:"#F44336",tz:15}]);this.money-=e,this.savings.push(this.saving+e)}purchase(e){if(this.money<e.price)return y.act("pop",[{t:"Insufficent funds",f:"#F44336",tz:15}]);this.money-=e.price,e.own=2,this.own.push(e)}},c=new A;var z=class u extends k{static res=["coins.png","ui/title.png","ui/resume.png","ui/options.png","ui/exit.png","ui/close.png","ui/menu.png","ui/bag.png","font/emulogic.ttf","music/bgm1_prototype.wav","sfx/button.mp3","sfx/whoosh.mp3","ui/button_up.png","ui/button_down.png","plan.png"];box(e,i,s=1,n=1,t=0){let r=[];"t"in e&&(r.push({t:e.t,tz:e.tz??20,b:"black",bz:e.bz??4,x:e.x??0,y:(e.y??0)+3,f:e.f??"white"}),delete e.t,delete e.tz,delete e.f,delete e.bz),"f"in e&&(r.push({f:e.f,x:(e.x??0)+(e.data?.x??0),y:(e.y??0)+(e.data?.y??0),s:.25,o:e.o??""}),delete e.f);let o=e.click;return"click"in e&&delete e.click,e.click=h=>{h.data&&h.data?.button&&i.play("sfx/button.mp3",.25),o&&o(h)},[{f:t==2?"ui/button_down.png":"ui/button_up.png",s:.25,crop:[60,59,60,59,57,56,s,n],press:h=>{h.data&&h.data.button&&(h.f="ui/button_down.png")},...e,data:{...e.data??{},button:t==0}},...r]}pop=[];pop_c=0;pop_t=0;help=0;help_c=0;v(...e){return e.map(i=>Math.max(0,1-Math.abs(this.m-i))).reduce((i,s)=>i+s,0)}menu=0;m=0;focus=null;title="Inventory";render(e,i,s){if(this.eng==null)return[];if(this.pop_c+=((this.pop.length?1:0)-this.pop_c)*e*10,this.pop.length&&this.pop_t==0){this.pop_t=performance.now();for(let o of this.pop)o.c=o.c??0}this.pop.length&&performance.now()-this.pop_t>3e3&&(this.pop=[]),this.help_c+=(this.help-this.help_c)*e*10,this.eng.inp.dkey.q==0&&(this.help=1-this.help),this.m+=(this.menu-this.m)*e*10;let n=(...o)=>o.map(h=>Math.max(0,1-Math.abs(this.m-h))).reduce((h,l)=>h+l,0),t=Math.floor(i/200)%4,r=(o,h=1,l=1,a=0)=>this.box(o,s,h,l,a);return this.menu!=2&&this.focus!=null&&Math.abs(this.m-2)>.99&&(this.focus=null),[{c:0,hover:o=>{o.click&&(o.cur="pointer")},tf:"font/emulogic.ttf"},{f:"music/bgm1_prototype.wav"},{f:"black",p:[[0,0],[],[s.w,s.h]],a:.5*n(0,2)},...this.focus==null?[]:s.merge(...this.focus.render(e,i,s)),{x:s.w*.5,y:s.h*.25*(2*n(0)-1),f:u.res[1],s:.35},{f:"coins.png",x:(s.w*.72+25)*n(0)-50*n(0)+25,y:(s.h*.2+25)*n(0)-50*n(0)+25,crop:[Math.abs(2-t)*22,0,22,23],sx:t==1?-1.5:1.5,sy:1.5},{t:String(c.money),tz:20,x:44,y:28-38*n(0),o:"w",f:"gold",b:"black",bz:4},{t:String(this.eng.fps),o:"nw",tz:8},...r({x:s.w/2,y:s.h-200*n(0)+50,t:"resume",f:"#4CAF50",click:o=>this.menu=1},10,2),...r({x:s.w/2,y:s.h-200*n(0)+105,t:"options",f:"#2196F3"},10,2),...r({x:s.w/2,y:s.h-200*n(0)+160,t:"exit",f:"#F44336"},10,2),...r({x:s.w+30-40*n(1),y:10,o:"ne",f:"ui/menu.png",click:o=>this.menu=0,data:{x:-3,y:9}}),...r({x:s.w+30-80*n(1),y:10,o:"ne",f:"ui/bag.png",click:o=>{this.title="Inventory",this.menu=2},data:{x:-7,y:7}}),...r({x:s.w+70-80*n(2),y:10,o:"ne",f:"ui/close.png",click:o=>{this.eng?.act("building_off"),this.menu=1},data:{x:-4,y:6}}),...this.focus==null||this.title.toLowerCase()=="inventory"?[...r({x:s.w/2,y:s.h+150-(s.h/2+135)*n(2)},40,20,1),...Array(8*4).fill(0).map((o,h)=>{let l=h%8,a=Math.floor(h/8);return{c:0,f:"ui/button_down.png",s:.25,crop:[60,59,60,59,57,56,3,3],x:75+70*l,y:90+70*a+(s.h-50)*(1-n(2))}})]:[...r({x:s.w+150-(s.w/2+5)*n(2),y:s.h/2+15},20,19,1),...this.focus instanceof f?r({x:s.w/4,y:s.h+25-(s.h/8+25)*n(2),...[{t:"Cant Own",f:"#F44336"},{t:"Purchase",f:"#4CAF50",click:o=>{this.focus instanceof f&&c.purchase(this.focus)}},{t:"Sell",f:"#2196F3"}][this.focus.own]??{t:"Unknown",f:"#F44336"}},15,2):[],...this.focus instanceof f&&this.focus.price&&this.focus.own==1?[{t:`\u20B1${this.focus.price}`,x:s.w/4,y:s.h+25-(s.h/4+15)*n(2),f:"white",a:.75}]:[],...this.focus instanceof f?this.focus.menu(e,i,s,this).map(o=>(o.c=o.c??0,o.x=(o.x??0)+s.w+150-(s.w/2+5)*n(2),o.y=(o.y??0)+s.h/2+15,o)):[]],...this.title.toLowerCase()=="inventory"?[{t:this.title,tz:20,b:"black",bz:4,x:s.w/2,y:28*n(2)-10*(1-n(2)),f:"skyblue"}]:[{t:this.title,tz:15,b:"black",bz:4,x:s.w/4,y:70*n(2)-10*(1-n(2)),f:"skyblue"}],...r({x:s.w/2,y:50*this.pop_c-30,click:o=>this.pop=[]},22,3),...this.pop.map(o=>(o.x=s.w/2,o.y=50*this.pop_c-25,o)),{f:"plan.png",o:"nw",s:.5,y:s.h*(1-this.help_c)}]}};var T=class extends f{static res=["building/bank.png"];static key="bank";own=0;name="DBO Bank";act_loan_pay=!1;act_save_out=!1;render(e,i,s){return[this.base(e,i,s),{f:"building/bank.png",p:[[-62,-100],[],[133,130],[]],m:[1,0,0,1,4,-32]}]}menu(e,i,s,n){let t=Math.max(...c.savings,...c.loans);return[...n.box({x:0,y:-90},s,19,4,2),{p:c.savings.length==1?[[0,60],[270,60]]:c.savings.map((r,o)=>[270*o/(c.savings.length-1),60*(1-r/t)]),b:"green",x:-135,y:-120,bz:2,a:.5},{p:c.loans.length==1?[[0,60],[270,60]]:c.loans.map((r,o)=>[270*o/(c.loans.length-1),60*(1-r/t)]),b:"red",x:-135,y:-120,bz:2,a:.5},{t:"Savings (5% rate)",o:"w",x:-140,y:-30,f:"black",tz:10,a:.75},{t:String(c.saving),o:"w",x:-140,y:-10,f:"black",tz:15},...n.box({x:-100,y:15,t:"1,000",tz:15,f:"black",bz:0,click:r=>c.saved(1e3*(this.act_save_out?-1:1))},s,5,1),...n.box({x:0,y:15,t:"10,000",tz:15,f:"black",bz:0,click:r=>c.saved(1e4*(this.act_save_out?-1:1))},s,6,1),...n.box({x:100,y:15,t:"100k",tz:15,f:"black",bz:0,click:r=>c.saved(1e5*(this.act_save_out?-1:1))},s,5,1),...n.box({x:90,y:-20,t:this.act_save_out?"deposit":"withdraw",tz:10,f:"black",bz:0,click:r=>this.act_save_out=!this.act_save_out},s,6,1),{t:"Loans (8% rate)",o:"w",x:-140,y:70,f:"black",tz:10,a:.75},{t:String(c.loan),o:"w",x:-140,y:90,f:"black",tz:15},...n.box({x:-100,y:115,t:"1,000",tz:15,f:"black",bz:0,click:r=>c.loaned(1e3*(this.act_loan_pay?-1:1))},s,5,1),...n.box({x:0,y:115,t:"10,000",tz:15,f:"black",bz:0,click:r=>c.loaned(1e4*(this.act_loan_pay?-1:1))},s,6,1),...n.box({x:100,y:115,t:"100k",tz:15,f:"black",bz:0,click:r=>c.loaned(1e5*(this.act_loan_pay?-1:1))},s,5,1),...n.box({x:90,y:80,t:this.act_loan_pay?"take loan":"pay back",tz:10,f:"black",bz:0,click:r=>this.act_loan_pay=!this.act_loan_pay},s,6,1)]}};var j=class extends f{static res=["building/blank_mask.png"];static key="blank";own=0;name="Private building";color=["white","white","white"];render(e,i,s){let n=this.base(e,i,s);return[{x:n.x??0,y:n.y??0,c:n.c??1},{p:[[-45,-33],[0,-7],[50,-20],[50,11],[0,24],[-38,2],[-45,0],[]],f:this.color[0]},{p:[[-45,-65],[0,-39],[50,-52],[50,-20],[0,-7],[-45,-33],[]],f:this.color[1]},{p:[[-49,-69.5],[8,-85],[54,-58],[54,-54],[53,-53],[53,-50],[0,-36],[-47,-64],[-47,-65],[-49,-67],[]],f:this.color[2]},{f:"building/blank_mask.png",p:[[-48,-85],[],[102,110],[]],m:[1,0,0,1,0,-30],...n}]}constructor(e,i,s,n){super(e,i,s,n),n.color?.length==3&&(this.color=n.color)}};var S=class extends f{static res=["building/callereal.png"];static key="callereal";own=0;name="CalleReal";render(e,i,s){return[this.base(e,i,s),{f:"building/callereal.png",p:[[-85,-140],[],[185,160],[]],m:[1,0,0,1,0,-60]}]}};var B=class extends f{static res=["building/factory.png"];static key="factory";name="Factory";render(e,i,s){return[this.base(e,i,s),{f:"building/factory.png",p:[[-75,-125],[],[165,145],[]],m:[1,0,0,1,0,-50]}]}};var I=class extends f{static res=["building/farm.png"];static key="farm";name="Farm";price=5e4;render(e,i,s){return[this.base(e,i,s),{f:"building/farm.png",p:[[-64,-49],[],[120,97],[]]}]}};var R=class extends f{static res=["building/fishing.png"];static key="fishing";name="Fishing Area";price=5e4;render(e,i,s){return[this.base(e,i,s,.75),{f:"building/fishing.png",m:[1,0,0,1,5,-35],p:[[-70,-80],[],[145,110],[]]}]}};var C=class u extends k{static res=["tile/grass_0.png","tile/sand_0.png","tile/sand1.png","tile/water_0.png","tile/water_1.png","tile/ws_x_0.png","tile/ws_y_0.png","tile/ws_xy_0.png","tile/ws__0.png","tile/ws_x_1.png","tile/ws_y_1.png","tile/ws_xy_1.png","tile/ws__1.png","tile/test.png","road/dirt.png","road/dirt_empty.png","road/cement.png","road/cement_empty.png","prop/tree.png","prop/bush.png","tile/water_bg_0.png","tile/water_bg_1.png","ui/pin.png"];static depend=[B,R,S,T,I,j];ly=[{},{}];tile(e,i){return{x:e*72+i*64,y:i*36-e*19}}generate(e=[]){this.ly=[{},{}];let[i,s]=this.ly;for(let n of e){let t=!0;if(n.w==null&&(n.w=1),n.h==null&&(n.h=1),n.type=="sand")this.eng?.tile([{},{data:{pre:"ws_xy"},m:[.312,.463,-2.45,-.23,-1,1]},{data:{pre:"ws_xy"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_y"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_xy"}},{data:{pre:"ws_x"}},{},{data:{pre:"ws_"},m:[-.2404,-.45704,2.5288,.2536,0,0]},{data:{pre:"ws_xy"},m:[-.355,.37,2.31,.38,-1,1]},{},{data:{pre:"ws_x"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_"},m:[1,0,0,1,-2,0]},{data:{pre:"ws_y"}},{data:{pre:"ws_"},m:[.95175,.235,.275,-.951,0,.6285]},{data:{pre:"ws_"},m:[.26139,.4746,-2.4687,-.27096,4.952,2.076]},{data:{pre:"sand"}}],i,n.x,n.y,n.w,n.h);else if(n.type=="grass"){let r="";for(let o=0;o<n.w;o++)for(let h=0;h<n.h;h++)i[r=`${o+n.x}_${h+n.y}`]&&i[r].data?.pre=="sand"&&(i[r].data={...i[r].data||{},top:"grass"})}else if(n.type=="dirt")for(let r=0;r<n.w;r++){let o=`${n.v?n.x:n.x+r}_${n.v?n.y+r:n.y}`;o in s?s[o]={f:"road/dirt_empty.png",m:[1.33725,-.071745,-.24675,1.2205,0,0]}:o in i&&(s[o]={f:"road/dirt.png",m:n.v?[1.33725,-.071745,-.24675,1.2205,0,0]:[-1.27025,-.39275,0,1.2135,0,0]})}else if(n.type=="cement")for(let r=0;r<n.w;r++){let o=`${n.v?n.x:n.x+r}_${n.v?n.y+r:n.y}`;o in s?s[o]={f:"road/cement_empty.png",m:[1.33725,-.071745,-.24675,1.2205,0,0]}:o in i&&(s[o]={f:"road/cement.png",m:n.v?[1.33725,-.071745,-.24675,1.2205,0,0]:[-1.27025,-.39275,0,1.2135,0,0]})}else n.type=="tree"?s[`${n.x}_${n.y}`]={f:"prop/tree.png",s:.08}:n.type=="bush"?s[`${n.x}_${n.y}`]={f:"prop/bush.png",s:.08}:t=!1;if(!t)for(let r of u.depend)n.type==r.key&&(s[`${n.x}_${n.y}`]={data:{build:new r(this,n.x,n.y,n)}},t=!0);t||this.eng?.error_add(new Error(`Unknown type "${n.type}`))}for(let n in this.ly)for(let t in this.ly[n]){let r=t.split("_").map(h=>Number(h)),o=this.ly[n][t];Object.assign(o,{x:r[0]*72+r[1]*64,y:r[1]*36-r[0]*19}),n=="0"&&o.data?.pre&&(o.f=`tile/${o.data.top||o.data.pre}_0.png`)}}init=!0;render(e,i,s){s.tile({f:`tile/water_bg_${Math.floor(i/800)%2}.png`,s:3});for(let t in this.ly[0]){let r=this.ly[0][t];r.data&&r.data.pre&&r.data.pre[0]=="w"&&!r.data.top&&(r.f=`tile/${r.data.pre}_${Math.floor(i/800)%2}.png`)}return[{hover:t=>{t.click&&(t.cur="pointer")}},...Object.values(this.ly[0]),...Object.values(this.ly[1]).map(t=>{if(t.data?.build){let r=t.data.build;return[...s.merge(...r.render(e,i,s)),...s.merge(...r.render_pin(e,i,s))]}return[t]}).reduce((t,r)=>[...t,...r],[])]}};var y=new $;y.base="/assets/";var F=new M("#game",y);F.fit=!0;F.scale(4);var X=[{type:"sand",x:-10,y:-10,w:20,h:20},{type:"grass",x:-9,y:-9,w:18,h:18},{type:"fishing",x:7,y:9},{type:"dirt",x:3,y:-8,w:16,v:!0},{type:"cement",x:-8,y:1,w:16},{type:"bank",x:2,y:0},{type:"tree",x:1.6,y:0},{type:"callereal",x:0,y:0},{type:"farm",x:-2,y:-.5},{type:"factory",x:-5,y:0},{type:"blank",x:5,y:0,color:["blue","brown","violet"]},{type:"blank",x:4,y:0,color:["red","yellow","green"]},{type:"bush",x:-2,y:0}];for(let u=0;u<10;u++)for(let e=0;e<10;e++)X.push({type:"tree",x:-8+e*.5+(Math.random()-.5),y:-8+u*.5+(Math.random()-.5)});var D=new L,Y=new E(y,D);Y.show(F);var P=new C(y),x=new z,K=new E(y,P,x);P.generate(X);y.act=(u,...e)=>{if(u=="building")x.menu==1&&setTimeout(()=>{if(x.menu!=1||!e.length||!(e[0]instanceof f))return;F.play("sfx/whoosh.mp3",.25,.4);let i=e[0];i.focused=!0,x.title=i.name,x.menu=2,x.focus=i},0);else if(u=="building_off")x.focus instanceof f&&(x.focus.focused=!1);else if(u=="pop"){let i=e[0];x.pop=i,x.pop_t=0}else if(u=="onmap?")return x.menu==1};y.load(u=>{D.per=u,u==1&&K.show()},z,C);y.loop=(u,e,i)=>{if(x.menu==0)return;let s=y.inp;if(x.menu==1){if(s.dsy){let n=Math.max(.25,Math.min(8,i.sx*Math.pow(1.5,-s.dsy/100)));i.s=n}if(s.cb(1)&&s.dx&&s.dy,s.b&1){i.x-=s.dx/i.sx,i.y-=s.dy/i.sy;let n=1300*Math.min(1,i.sx),t=600*Math.min(1,i.sy);i.x=Math.min(n,Math.max(-n,i.x)),i.y=Math.min(t,Math.max(-t,i.y))}}};})();</script></body></html>