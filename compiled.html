<!DOCTYPE html><html><head><title>Noble City</title><style>html,body{background-color:#111;width:100%;height:100%;margin:0;padding:0;overflow:hidden;display:flex;justify-content:center;align-items:center;}canvas{display:block;image-rendering:pixelated;object-fit:contain;box-shadow:0 0 30px #000}</style></head><body><canvas id="game"></canvas><script>(()=>{var v=class{x=0;y=0;get w(){return this.dom.width}set w(t){this.dom.width=t}get h(){return this.dom.height}set h(t){this.dom.height=t}set s(t){this.sx=t,this.sy=t}sx=1;sy=1;def={bz:1};cursor="default";render(t={},...i){let n=this.cursor;for(let s of i){this._ctx.save();let e={};Object.assign(e,this.def,t,s);let r=(...g)=>g.filter(k=>k!=null)[0],o=this._eng.inp;(e.click||e.hover)&&e.p!=null&&o.over(e.p,[e.x||0,e.y||0],e.c)&&(e.hover&&e.hover(e),o.click()&&e.click&&e.click(e)),e.cur&&(n=e.cur);let a=e.f!=null&&!(e.f in this._eng.imgs),m=e.b!=null&&!(e.b in this._eng.imgs),h=e.crop!=null&&e.crop.length==4;a&&(this._ctx.fillStyle=e.f),m&&(this._ctx.strokeStyle=e.b),this._ctx.lineCap=e.be=="arc"?"round":e.be=="sqr"?"square":"butt",this._ctx.lineJoin=e.bj=="arc"?"round":e.bj=="sqr"?"bevel":"miter",this._ctx.lineWidth=r(e.bz,this.def.bz,1),this._ctx.globalAlpha=r(e.a,this.def.a,1),this._ctx.save();let d=r(e.c,this.def.c,1),l=Math.pow(this.sx,d),u=Math.pow(this.sy,d),p=r(e.sx,e.s,this.def.sx,this.def.s,1),x=r(e.sy,e.s,this.def.sy,this.def.s,1);p*=l,x*=u;let _=0,w=1;e.r&&(_=Math.sin(e.r),w=Math.cos(e.r)),this._ctx.transform(p*w,p*_,-x*_,x*w,this.w/2*d*Math.pow(this.sx,d-1)+this.x*(1-d-l)+(e.x||0)*l,this.h/2*d*Math.pow(this.sy,d-1)+this.y*(1-d-u)+(e.y||0)*u),e.m&&e.m.length==6?this._ctx.transform.apply(this._ctx,e.m):e.m&&this._eng.error_add(new Error(`Invalid transform [${e.m.toString()}]`)),this._ctx.textAlign="left",this._ctx.textBaseline="top";let b=[0,0];(!e.o||!e.o.includes("w")&&!e.o.includes("e"))&&(e.crop&&h?b[0]-=e.crop[2]/2:e.f&&!a&&(b[0]-=this._eng.imgs[e.f].width/2),this._ctx.textAlign="center"),(!e.o||!e.o.includes("n")&&!e.o.includes("s"))&&(e.crop&&h?b[1]-=e.crop[3]/2:e.f&&!a&&(b[1]-=this._eng.imgs[e.f].height/2),this._ctx.textBaseline="middle"),e.o&&e.o.includes("e")&&(e.crop&&h?b[0]-=e.crop[2]:e.f&&!a&&(b[0]-=this._eng.imgs[e.f].width),this._ctx.textAlign="end"),e.o&&e.o.includes("s")&&(e.crop&&h?b[1]-=e.crop[3]:e.f&&!a&&(b[1]-=this._eng.imgs[e.f].width),this._ctx.textBaseline="bottom"),this._ctx.translate(b[0],b[1]),e.f!=null&&e.f in this._eng.imgs&&(e.crop&&h?this._ctx.drawImage(this._eng.imgs[e.f],e.crop[0],e.crop[1],e.crop[2],e.crop[3],0,0,e.crop[2],e.crop[3]):this._ctx.drawImage(this._eng.imgs[e.f],0,0),m&&e.p==null&&(e.crop&&h?this._ctx.strokeRect(0,0,e.crop[2],e.crop[3]):this._ctx.strokeRect(0,0,this._eng.imgs[e.f].width,this._eng.imgs[e.f].height)));let T=this._ctx.textAlign,j=this._ctx.textBaseline;if(this._ctx.restore(),this._ctx.textAlign=T,this._ctx.textBaseline=j,this._ctx.transform(l*w,l*_,-u*_,u*w,this.w/2*d*Math.pow(this.sx,d-1)+this.x*(1-d-l)+(e.x||0)*l,this.h/2*d*Math.pow(this.sy,d-1)+this.y*(1-d-u)+(e.y||0)*u),e.p){let g=0,k=0;this._ctx.beginPath();for(let f of e.p)f.length==2&&!g?this._ctx.moveTo(f[0],f[1]):f.length==2&&k==1?(this._ctx.lineTo(e.p[g-2][0]+f[0],e.p[g-2][1]),this._ctx.lineTo(e.p[g-2][0]+f[0],e.p[g-2][1]+f[1]),this._ctx.lineTo(e.p[g-2][0],e.p[g-2][1]+f[1])):f.length==2?this._ctx.lineTo(f[0],f[1]):f.length==0&&g>0&&e.p[g-1].length==2&&g+1!=e.p.length&&e.p[g+1].length==2?k=1:f.length==0&&g+1==e.p.length&&this._ctx.closePath(),g++;a&&this._ctx.fill(),m&&this._ctx.stroke()}e.t&&(this._ctx.font=`${e.tz!=null?e.tz:20}px ${e.tf!=null?e.tf:"Arial"}`,a||(this._ctx.fillStyle="#000"),(!a&&!m||a)&&this._ctx.fillText(e.t,0,0),m&&this._ctx.strokeText(e.t,0,0)),this._ctx.restore()}this.dom.style.cursor=n}clear(){this._ctx.clearRect(0,0,this.w,this.h)}tile(t){let i=t.sx!=null?t.sx:t.s!=null?t.s:this.def.sx!=null?this.def.sx:this.def.s!=null?this.def.s:1,n=t.sy!=null?t.sy:t.s!=null?t.s:this.def.sy!=null?this.def.sy:this.def.s!=null?this.def.s:1,s=this.dom.getBoundingClientRect(),e=s.width/this.w,r=s.height/this.h;!t.f||!(t.f in this._eng.imgs)?t.f!=null&&(this.dom.style.background=t.f):(this.dom.style.backgroundImage=`url(${this._eng.base}${t.f})`,this.dom.style.backgroundPosition=`calc(50% + ${((t.x||0)-this.x)*this.sx*e}px) calc(50% + ${((t.y||0)-this.y)*this.sy*r}px)`,this.dom.style.backgroundSize=`${this._eng.imgs[t.f].width*this.sx*i}px ${this._eng.imgs[t.f].height*this.sy*n}px`)}dom;_ctx;_eng;constructor(t="",i,n=640,s=360){this.dom=typeof t!="string"?t:t.length&&document.querySelector(t)?document.querySelector(t):document.createElement("canvas"),this.dom.style.aspectRatio=`${n} / ${s}`,this.w=n,this.h=s,this._ctx=this.dom.getContext("2d"),this._ctx.imageSmoothingEnabled=!1,this._eng=i,i.cameras.push(this),i.inp.bind(this)}},z=class{x=0;_x=0;_gx=0;get dx(){return this.x-this._x}set dx(t){this._x=this.x-t}y=0;_y=0;_gy=0;get dy(){return this.y-this._y}set dy(t){this._y=this.y-t}rx=0;_rx=0;_grx=0;get drx(){return this.rx-this._rx}set drx(t){this._rx=this.rx-t}ry=0;_ry=0;_gry=0;get dry(){return this.ry-this._ry}set dry(t){this._ry=this.ry-t}b=0;_b=0;get db(){return this.b^this._b}set db(t){this._b=this.b^t}cb(t,i=null){return(this.db&t)!=0&&(i==null?(this.b&t)!=0:(this.b&t)==i)}sx=0;_sx=0;get dsx(){return this.sx-this._sx}set dsx(t){this._sx=this.sx-t}sy=0;_sy=0;get dsy(){return this.sy-this._sy}set dsy(t){this._sy=this.sy-t}get gx(){return this.x-this._gx}get gy(){return this.y-this._gy}get grx(){return this.rx-this._grx}get gry(){return this.ry-this._gry}get g(){return Math.hypot(this.gx,this.gy)}get gr(){return Math.hypot(this.grx,this.gry)}click(t=1){return this.g<t&&this.cb(1,0)}over(t,i=[0,0],n){let s=n??(this._cam.def.c!=null?this._cam.def.c:1),e=(this.x-this._cam.w/2*s+this._cam.x*s)*Math.pow(this._cam.sx,-s)-i[0],r=(this.y-this._cam.h/2*s+this._cam.y*s)*Math.pow(this._cam.sy,-s)-i[1],o=!1;for(let a=0,m=t.length-1;a<t.length;m=a++){let h=t[a].length==2&&t[m].length==2;if(a==0&&t[m].length==0&&m--,a!=0&&a+1<t.length&&t[a].length==0&&t[a-1].length==2&&t[a+1].length==2){let d=t[a-1][0],l=t[a-1][1],u=d+t[a+1][0],p=l+t[a+1][1];l>r!=p>r&&d>e!=u>e&&(o=!o),a++}else if(h){let d=t[a][0],l=t[a][1],u=t[m][0],p=t[m][1];l>r!=p>r&&e<(u-d)*(r-l)/(p-l)+d&&(o=!o)}}return o}in(...t){for(let i of t)if(this.x>i[0]&&this.x<i[0]+i[2]&&this.y>i[1]&&this.y<i[1]+i[3])return!0;return!1}rin(...t){for(let i of t)if(this.rx>i[0]&&this.rx<i[0]+i[2]&&this.ry>i[1]&&this.ry<i[1]+i[3])return!0;return!1}key={};dkey={};handle(t){if(t instanceof WheelEvent)this.sx+=t.deltaX,this.sy+=t.deltaY;else if(t instanceof MouseEvent){let i=this._cam.dom.getBoundingClientRect(),n=this._cam.w/this._cam.h,s=n>i.width/i.height?[i.width,i.width/n]:[i.height*n,i.height];this.x=(t.clientX-i.left-(i.width-s[0])/2)/s[0]*this._cam.w,this.y=(t.clientY-i.top-(i.height-s[1])/2)/s[1]*this._cam.h,this.rx=(this.x-this._cam.w/2+this._cam.x)/this._cam.sx,this.ry=(this.y-this._cam.h/2+this._cam.y)/this._cam.sy,this.b=t.buttons,this.cb(1)&&(this._gx=this.x,this._gy=this.y,this._grx=this.rx,this._gry=this.ry),t.preventDefault()}else t instanceof KeyboardEvent&&(t.type=="keydown"?this.key[t.key.toLowerCase()]=this.dkey[t.key.toLowerCase()]=Number(t.ctrlKey)+(Number(t.shiftKey)<<1)+(Number(t.altKey)<<2):(delete this.key[t.key.toLowerCase()],this.dkey[t.key.toLowerCase()]=-1))}reset(){this.dx=0,this.dy=0,this.db=0,this.dsx=0,this.dsy=0,this.drx=0,this.dry=0,this.dkey={}}constructor(t){this._eng=t}_eng;bind(t){this._cam=t,addEventListener("wheel",i=>this.handle(i)),addEventListener("mousemove",i=>this.handle(i)),addEventListener("mouseover",i=>this.handle(i)),addEventListener("mousedown",i=>this.handle(i)),addEventListener("mouseup",i=>this.handle(i)),addEventListener("mouseenter",i=>this.handle(i)),addEventListener("mouseout",i=>this.handle(i)),addEventListener("keydown",i=>this.handle(i)),addEventListener("keyup",i=>this.handle(i))}_cam},y=class{static res=[];render(t,i,n,s){return[]}constructor(...t){}},E=class{imgs={};load_res(t,...i){let n=0;t(0,i.length);for(let s of i){let e=new Image;e.onload=()=>t(n==-1?-1:++n,i.length),e.onerror=()=>{n=-1,this.load_err.push(this.base+s),t(-1,i.length)},e.src=this.base+s,this.imgs[s]=e}}load_err=[];errors=[];error_add(t){for(let i of this.errors)if(i.message==t.message)return;this.errors.push(t),console.log(t)}base="";load(t,...i){let n=[];for(let s of i)n.push(...s.res);this.load_res(t,...n)}cameras=[];inp;debug={m:[1,0,0,1,0,0],_m:[1,0,0,1,0,0],mp:t=>{if(this.inp.key.a!=null&&(this.debug.m[0]-=t*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.m[0]+=t*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),this.inp.key.q!=null&&(this.debug.m[1]-=t*(this.inp.key.q==0?1:this.inp.key.q&2?.25:0)),this.inp.key.e!=null&&(this.debug.m[1]+=t*(this.inp.key.e==0?1:this.inp.key.e&2?.25:0)),this.inp.key.s!=null&&(this.debug.m[3]-=t*(this.inp.key.s==0?1:this.inp.key.s&2?.25:0)),this.inp.key.w!=null&&(this.debug.m[3]+=t*(this.inp.key.w==0?1:this.inp.key.w&2?.25:0)),this.inp.key.x!=null&&(this.debug.m[2]-=t*(this.inp.key.x==0?1:this.inp.key.x&2?.25:0)),this.inp.key.z!=null&&(this.debug.m[2]+=t*(this.inp.key.z==0?1:this.inp.key.z&2?.25:0)),this.inp.key.c!=null&&(this.debug.m[4]-=t*(this.inp.key.c==0?4:this.inp.key.c&2?.25:0)),this.inp.key.v!=null&&(this.debug.m[4]+=t*(this.inp.key.v==0?4:this.inp.key.v&2?.25:0)),this.inp.key.r!=null&&(this.debug.m[5]-=t*(this.inp.key.r==0?4:this.inp.key.r&2?.25:0)),this.inp.key.f!=null&&(this.debug.m[5]+=t*(this.inp.key.f==0?4:this.inp.key.f&2?.25:0)),this.inp.key[1]!=null||this.inp.key[2]!=null){let i=Math.PI/16*t*(this.inp.key[1]!=null?1:-1),n=Math.cos(i),s=Math.sin(i),e=[...this.debug.m];this.debug.m=[e[0]*n+e[2]*s,e[1]*n+e[3]*s,e[2]*n-e[0]*s,e[3]*n-e[1]*s,e[4],e[5]]}if(!Object.keys(this.inp.key).length){for(let i=0;i<6;i++)if(this.debug.m[i]!=this.debug._m[i]){console.log("DEBUG MATRIX:",this.debug.m.toString()),this.debug._m=[...this.debug.m];break}}}};_wait=0;_times=[];_start;get fps(){return this._times.length}set fps(t){this._wait=t?2e3/t:0}scenes=[];scene=-1;start_loop(t=!0){let i=performance.now(),n=this._times.length?i-this._times[this._times.length-1]:0;this._times=this._times.filter(e=>i-e<=1e3),this._times.push(i),t&&(this._start=i);let s=0;if(this.scene!=-1)for(let e of this.cameras){e.clear();for(let r of this.scenes[this.scene])e.render(...r.render(n/1e3,i-this._start,this,e));this.loop(n/1e3,i-this._start,e),s++}this.inp.reset(),setTimeout(()=>this.start_loop(!1),this._wait-n>0?this._wait-n:0)}loop=()=>{};constructor(){this.inp=new z(this),this.start_loop()}};var L=class extends y{per=.5;render(t,i,n){return[{},{p:[[-100,-10],[],[200,20],[]],b:this.per<0?"red":"white",bz:2},{a:this.per<0?0:1,p:[[-96,-6],[],[192*this.per,12],[]],f:"white"},{t:this.per<0?"Error loading assets":"Loading...",y:-30,f:this.per<0?"red":"white"},{a:this.per<0?.75:0,t:`failed: ${n.load_err[n.load_err.length-1]}`,y:30,tz:15,f:"red"}]}},M=class c extends y{static res=["coins.png","ui/title.png","ui/resume.png","ui/options.png","ui/exit.png","ui/menu.png"];menu=1;m=1;render(t,i,n,s){return t<1&&(this.m+=(this.menu-this.m)*t*10),[{c:0},{f:"black",p:[[0,0],[],[s.w,s.h]],a:this.m<1?.25*(1-this.m):0},{x:s.w*.5,y:s.h*(.5-this.m)/2,f:c.res[1],s:.35},{f:c.res[0],x:s.w*.72*(1-this.m)+this.m*25,y:s.h*.2*(1-this.m)+this.m*25,crop:[Math.abs(2-Math.floor(i/200)%4)*22,0,22,23],s:1.5,sx:Math.floor(i/200)%4==1?-1.5:1.5},{t:String(n.fps),o:"nw",tz:8},{f:c.res[2],x:s.w/2,y:s.h-150+this.m*200,s:.5,p:[[-73,-25],[],[155,48],[]],hover:e=>e.cur="pointer",click:e=>this.menu=1},{f:c.res[3],x:s.w/2,y:s.h-95+this.m*200,s:.5},{f:c.res[4],x:s.w/2,y:s.h-40+this.m*200,s:.5},{f:"ui/menu.png",o:"ne",x:s.w+(30-40*this.m),y:10,s:.25,p:[[-30,0],[],[30,30],[]],hover:e=>e.cur="pointer",click:e=>this.menu=0}]}},C=class extends y{static res=["tile/grass_0.png","tile/sand_0.png","tile/sand1.png","tile/water.png","tile/ws_x_0.png","tile/ws_y_0.png","tile/ws_xy_0.png","tile/ws__0.png","tile/ws_x_1.png","tile/ws_y_1.png","tile/ws_xy_1.png","tile/test.png","road/dirt.png","road/dirt_empty.png","building/fishing.png","ocean.png"];bg={};rd={};bd={};tile(t,i){return{x:t*72+i*64,y:i*36-t*19}}set_tile(t,i,n=0,s=0,e=1,r=1){let o="",a={},m=(h,d,l)=>{let u=`${n+d}_${s+l}`,p=0;i[u]&&i[u].data&&i[u].data.p&&(p=i[u].data.p);let x=structuredClone(t[p|h]);x.f||(x.f="tile/test.png"),x.data={...i[u]?.data||{},...t[p|h]?.data||{},p:p|h},i[u]=x};for(let h=0;h<e;h++)for(let d=0;d<r;d++)m(15,h,d);for(let h=0;h<e;h++)m(3,h,-1);for(let h=0;h<e;h++)m(12,h,r);for(let h=0;h<r;h++)m(5,-1,h);for(let h=0;h<r;h++)m(10,e,h);m(1,-1,-1),m(2,e,-1),m(4,-1,r),m(8,e,r)}generate(t=[]){let i=(e,r)=>e+13*r+71,n={};this.rd={};let s={};this.bd={};for(let e of t)if(e.w==null&&(e.w=1),e.h==null&&(e.h=1),e.type=="sand")this.set_tile([{},{data:{pre:"ws_xy"},m:[.312,.463,-2.45,-.23,-1,1]},{data:{pre:"ws_xy"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_y"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_xy"}},{data:{pre:"ws_x"}},{},{data:{pre:"ws_"},m:[-.2404,-.45704,2.5288,.2536,0,0]},{data:{pre:"ws_xy"},m:[-.355,.37,2.31,.38,-1,1]},{},{data:{pre:"ws_x"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_"},m:[1,0,0,1,-2,0]},{data:{pre:"ws_y"}},{data:{pre:"ws_"},m:[.95175,.235,.275,-.951,0,.6285]},{data:{pre:"ws_"},m:[.26139,.4746,-2.4687,-.27096,4.952,2.076]},{data:{pre:"sand"}}],s,e.x,e.y,e.w,e.h);else if(e.type=="grass"){let r="";for(let o=0;o<e.w;o++)for(let a=0;a<e.h;a++)s[r=`${o+e.x}_${a+e.y}`]&&s[r].data?.pre=="sand"&&(s[r].data={...s[r].data||{},top:"grass"})}for(let e in s){let r=e.split("_").map(o=>Number(o));Object.assign(s[e],this.tile(r[0],r[1])),s[e].data.pre&&(s[e].f=`tile/${s[e].data.top||s[e].data.pre}_0.png`)}for(let e in n){let r=e.split("_").map(o=>Number(o));Object.assign(n[e],this.tile(r[0],r[1]))}this.bg=s,this.rd=n,console.log(this.bg)}init=!0;render(t,i,n,s){return s.tile({f:"ocean.png",s:1}),[{},...Object.values(this.bg),...Object.values(this.rd)]}};var $=class{game;cam;ui=new M;loadmenu=new L;map=new C;mapdat=[{type:"sand",x:-2,y:-2,w:4,h:4},{type:"grass",x:-2,y:-2,w:4,h:4},{type:"sand",x:2,y:1,w:2,h:2},{type:"grass",x:2,y:1,w:2,h:2},{type:"sand",x:-1,y:1,h:3},{type:"grass",x:-1,y:2,w:1,h:3},{type:"grass",x:1,y:1},{type:"dirt",x:-1,y:-1,v:!0,w:4},{type:"dirt",x:-2,y:1,w:4},{type:"fishing",x:0,y:0}];resize(){let t=this.cam.w/this.cam.h;innerWidth/innerHeight>t?(this.cam.dom.style.width="auto",this.cam.dom.style.height="100%"):(this.cam.dom.style.width="100%",this.cam.dom.style.height="auto")}constructor(t=""){this.game=new E,this.game.base="/assets/",this.cam=new v(t,this.game),this.cam.x=200,addEventListener("resize",()=>this.resize),this.resize(),this.game.scenes.push([this.loadmenu]),this.game.scenes.push([this.map,this.ui]),this.game.scene=0,this.map.generate(this.mapdat),this.game.load((i,n)=>{this.loadmenu.per=i/n,i/n==1&&(this.game.scene=1)},M,C),this.game.loop=(i,n,s)=>this.loop(i,n,s)}pos=[-1,3,1,3];loop(t,i,n){if(this.ui.menu==0)return;let s=this.game.inp;if(s.dsy){let e=Math.max(.125,Math.min(8,n.sx*Math.pow(2,-s.dsy/100)));n.x=(s.rx*e/n.sx+n.w/2-s.x)/e,n.y=(s.ry*e/n.sy+n.h/2-s.y)/e,n.s=e}s.cb(1)&&(s.dx=0,s.dy=0),s.b&1&&(n.x-=s.dx/n.sx,n.y-=s.dy/n.sy)}},B=new $("#game");})();</script></body></html>